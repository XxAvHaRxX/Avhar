<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <title>–ù–∞—Ä—É—Ç–æ: –ü—É—Ç—å –®–∏–Ω–æ–±–∏ - Telegram Mini App</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tg-theme-bg-color: #1a202c;
            --tg-theme-text-color: #e2e8f0;
            --tg-theme-hint-color: #a0aec0;
            --tg-theme-link-color: #4299e1;
            --tg-theme-button-color: #4299e1;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #2d3748;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: 1rem;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
        }
        
        h1, h2 {
            color: var(--tg-theme-link-color);
            font-weight: 700;
            text-align: center;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--tg-theme-hint-color);
        }
        
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #4a5568;
            background-color: #4a5568;
            color: var(--tg-theme-text-color);
            margin-bottom: 1rem;
        }
        
        button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            padding: 0.6rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 600;
            width: 100%;
            font-size: 0.95rem;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
        }
        
        .message-box {
            background-color: #2c5282;
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            text-align: center;
        }
        
        .stat-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }
        
        .stat-input-group label {
            flex: 1;
            margin-bottom: 0;
        }
        
        .stat-input-group input {
            width: 60px;
            margin-bottom: 0;
            text-align: center;
        }
        
        .stat-controls {
            display: flex;
            gap: 0.5rem;
            margin-left: 1rem;
        }
        
        .stat-controls button {
            width: 30px;
            height: 30px;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            line-height: 1;
        }
        
        .game-section {
            border-top: 1px solid #4a5568;
            padding-top: 1rem;
            margin-top: 1rem;
        }
        
        .game-output {
            background-color: rgba(0, 0, 0, 0.2);
            padding: 0.75rem;
            border-radius: 0.5rem;
            min-height: 120px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .combat-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        /* Telegram Header Styles */
        .tg-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 1rem;
            background-color: var(--tg-theme-secondary-bg-color);
            border-bottom: 1px solid #4a5568;
        }
        
        .tg-back-button {
            background: none;
            border: none;
            color: var(--tg-theme-link-color);
            font-size: 1rem;
            cursor: pointer;
            width: auto;
            padding: 0;
        }
        
        /* Responsive Adaptations */
        @media (max-width: 768px) {
            .container {
                padding: 0.75rem;
                border-radius: 0;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            h2 {
                font-size: 1.25rem;
            }
            
            .game-output {
                min-height: 100px;
                max-height: 150px;
                font-size: 0.85rem;
            }
            
            button {
                padding: 0.5rem;
                font-size: 0.9rem;
            }
            
            .combat-actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Telegram Mini Apps Header -->
    <div class="tg-header">
        <button id="tgBackButton" class="tg-back-button">‚Üê –ù–∞–∑–∞–¥</button>
        <h1>–ù–∞—Ä—É—Ç–æ: –ü—É—Ç—å –®–∏–Ω–æ–±–∏</h1>
        <button id="tgSaveButton" style="background: none; border: none; color: #4299e1; width: auto;">üíæ</button>
    </div>

    <div class="container">
        <!-- Character Creation Section -->
        <div id="characterCreation" class="game-section">
            <h2 class="text-2xl mb-4">–°–æ–∑–¥–∞–Ω–∏–µ –ü–µ—Ä—Å–æ–Ω–∞–∂–∞</h2>
            <form id="characterForm">
                <label for="charName">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
                <input type="text" id="charName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" required class="mb-4">

                <label for="charVillage">–í—ã–±–µ—Ä–∏ –¥–µ—Ä–µ–≤–Ω—é:</label>
                <select id="charVillage" class="mb-4">
                    <option value="–ö–æ–Ω–æ—Ö–∞–≥–∞–∫—É—Ä–µ">–ö–æ–Ω–æ—Ö–∞–≥–∞–∫—É—Ä–µ (–°–∫—Ä—ã—Ç—ã–π –õ–∏—Å—Ç)</option>
                    <option value="–ö—É–º–æ–≥–∞–∫—É—Ä–µ">–ö—É–º–æ–≥–∞–∫—É—Ä–µ (–°–∫—Ä—ã—Ç–æ–µ –û–±–ª–∞–∫–æ)</option>
                    <option value="–ö–∏—Ä–∏–≥–∞–∫—É—Ä–µ">–ö–∏—Ä–∏–≥–∞–∫—É—Ä–µ (–°–∫—Ä—ã—Ç—ã–π –¢—É–º–∞–Ω)</option>
                    <option value="–ò–≤–∞–≥–∞–∫—É—Ä–µ">–ò–≤–∞–≥–∞–∫—É—Ä–µ (–°–∫—Ä—ã—Ç—ã–π –ö–∞–º–µ–Ω—å)</option>
                    <option value="–°—É–Ω–∞–≥–∞–∫—É—Ä–µ">–°—É–Ω–∞–≥–∞–∫—É—Ä–µ (–°–∫—Ä—ã—Ç—ã–π –ü–µ—Å–æ–∫)</option>
                </select>

                <label for="charChakraElement">–í—ã–±–µ—Ä–∏ —Å—Ç–∏—Ö–∏—é —á–∞–∫—Ä—ã:</label>
                <select id="charChakraElement" class="mb-4">
                    <option value="–í–µ—Ç–µ—Ä">–í–µ—Ç–µ—Ä (–§—É—Ç–æ–Ω)</option>
                    <option value="–ú–æ–ª–Ω–∏—è">–ú–æ–ª–Ω–∏—è (–†–∞–π—Ç–æ–Ω)</option>
                    <option value="–í–æ–¥–∞">–í–æ–¥–∞ (–°—É–π—Ç–æ–Ω)</option>
                    <option value="–û–≥–æ–Ω—å">–û–≥–æ–Ω—å (–ö–∞—Ç–æ–Ω)</option>
                    <option value="–ó–µ–º–ª—è">–ó–µ–º–ª—è (–î–æ—Ç–æ–Ω)</option>
                </select>

                <h3 class="text-xl mb-2 text-center text-blue-300">–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ 10 –æ—á–∫–æ–≤ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫:</h3>
                <p id="remainingPoints" class="text-center text-lg mb-4 text-yellow-300">–û—Å—Ç–∞–ª–æ—Å—å –æ—á–∫–æ–≤: 10</p>

                <div class="stat-input-group">
                    <label for="statStrength">–°–∏–ª–∞:</label>
                    <input type="number" id="statStrength" value="0" min="0" max="10" readonly>
                    <div class="stat-controls">
                        <button type="button" class="add-stat-btn" data-stat="Strength">+</button>
                        <button type="button" class="remove-stat-btn" data-stat="Strength">-</button>
                    </div>
                </div>
                <div class="stat-input-group">
                    <label for="statAgility">–õ–æ–≤–∫–æ—Å—Ç—å:</label>
                    <input type="number" id="statAgility" value="0" min="0" max="10" readonly>
                    <div class="stat-controls">
                        <button type="button" class="add-stat-btn" data-stat="Agility">+</button>
                        <button type="button" class="remove-stat-btn" data-stat="Agility">-</button>
                    </div>
                </div>
                <div class="stat-input-group">
                    <label for="statStamina">–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å:</label>
                    <input type="number" id="statStamina" value="0" min="0" max="10" readonly>
                    <div class="stat-controls">
                        <button type="button" class="add-stat-btn" data-stat="Stamina">+</button>
                        <button type="button" class="remove-stat-btn" data-stat="Stamina">-</button>
                    </div>
                </div>
                <div class="stat-input-group">
                    <label for="statChakra">–ß–∞–∫—Ä–∞:</label>
                    <input type="number" id="statChakra" value="0" min="0" max="10" readonly>
                    <div class="stat-controls">
                        <button type="button" class="add-stat-btn" data-stat="Chakra">+</button>
                        <button type="button" class="remove-stat-btn" data-stat="Chakra">-</button>
                    </div>
                </div>
                <div class="stat-input-group">
                    <label for="statIntellect">–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç:</label>
                    <input type="number" id="statIntellect" value="0" min="0" max="10" readonly>
                    <div class="stat-controls">
                        <button type="button" class="add-stat-btn" data-stat="Intellect">+</button>
                        <button type="button" class="remove-stat-btn" data-stat="Intellect">-</button>
                    </div>
                </div>

                <label for="charAppearance" class="mt-4">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–Ω–µ—à–Ω–æ—Å—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):</label>
                <input type="text" id="charAppearance" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '–ú–æ–ª–æ–¥–æ–π –Ω–∏–Ω–¥–∑—è —Å —Ä–∞—Å—Ç—Ä–µ–ø–∞–Ω–Ω—ã–º–∏ —á–µ—Ä–Ω—ã–º–∏ –≤–æ–ª–æ—Å–∞–º–∏...'">

                <button type="submit" id="createCharBtn" class="mt-6">–°–æ–∑–¥–∞—Ç—å –ü–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
            </form>
            <div id="messageBox" class="message-box hidden"></div>
        </div>

        <!-- Game Interface Section -->
        <div id="gameInterface" class="game-section hidden">
            <h2 class="text-2xl mb-4">–ú–∏—Ä –®–∏–Ω–æ–±–∏</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <button id="showProfileBtn">–ü–æ–∫–∞–∑–∞—Ç—å –ü—Ä–æ—Ñ–∏–ª—å</button>
                <button id="showMissionsBtn">–ú–∏—Å—Å–∏–∏</button>
                <button id="showInventoryBtn">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
                <button id="showTrainingBtn">–û–±—É—á–µ–Ω–∏–µ</button>
            </div>

            <!-- Game Output Area -->
            <div id="gameOutput" class="game-output">
                –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä –ù–∞—Ä—É—Ç–æ: –ü—É—Ç—å –®–∏–Ω–æ–±–∏!
            </div>

            <!-- Profile Display -->
            <div id="profileDisplay" class="hidden">
                <h3 class="text-xl mb-2 text-blue-300">–ü—Ä–æ—Ñ–∏–ª—å –ü–µ—Ä—Å–æ–Ω–∞–∂–∞</h3>
                <p><strong>–ò–º—è:</strong> <span id="profileName"></span></p>
                <p><strong>–î–µ—Ä–µ–≤–Ω—è:</strong> <span id="profileVillage"></span></p>
                <p><strong>–°—Ç–∏—Ö–∏—è –ß–∞–∫—Ä—ã:</strong> <span id="profileElement"></span></p>
                <p><strong>–£—Ä–æ–≤–µ–Ω—å:</strong> <span id="profileLevel"></span></p>
                <p><strong>–û–ø—ã—Ç:</strong> <span id="profileExp"></span> / <span id="profileExpToNextLevel"></span></p>
                <p><strong>–ó–¥–æ—Ä–æ–≤—å–µ (HP):</strong> <span id="profileHP"></span> / <span id="profileMaxHP"></span></p>
                <p><strong>–ß–∞–∫—Ä–∞ (CP):</strong> <span id="profileCP"></span> / <span id="profileMaxCP"></span></p>
                <p><strong>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:</strong></p>
                <ul>
                    <li>–°–∏–ª–∞: <span id="profileStrength"></span></li>
                    <li>–õ–æ–≤–∫–æ—Å—Ç—å: <span id="profileAgility"></span></li>
                    <li>–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å: <span id="profileStamina"></span></li>
                    <li>–ß–∞–∫—Ä–∞: <span id="profileChakra"></span></li>
                    <li>–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç: <span id="profileIntellect"></span></li>
                </ul>
                <p><strong>–í–Ω–µ—à–Ω–æ—Å—Ç—å:</strong> <span id="profileAppearance"></span></p>
                <h4 class="text-lg mt-2 text-blue-200">–î–∑—é—Ü—É:</h4>
                <ul id="profileJutsuList"></ul>
                <h4 class="text-lg mt-2 text-blue-200">–≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞:</h4>
                <ul id="profileEquipmentList"></ul>
            </div>

            <!-- Missions Display -->
            <div id="missionsDisplay" class="hidden">
                <h3 class="text-xl mb-2 text-blue-300">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ú–∏—Å—Å–∏–∏</h3>
                <ul id="missionList" class="mb-4">
                    <!-- Missions will be dynamically loaded here -->
                </ul>
                <button id="takeMissionBtn" class="mb-2">–í–∑—è—Ç—å –ú–∏—Å—Å–∏—é</button>
                <button id="completeMissionBtn" class="mb-2 hidden">–°–¥–∞—Ç—å –ú–∏—Å—Å–∏—é</button>
                <div id="missionMessageBox" class="message-box hidden"></div>
            </div>

            <!-- Combat Display -->
            <div id="combatDisplay" class="hidden">
                <h3 class="text-xl mb-2 text-red-300">–ë–æ–π!</h3>
                <div id="combatLog" class="game-output mb-4"></div>
                <p>–¢–≤–æ–µ HP: <span id="playerCombatHP"></span> / <span id="playerCombatMaxHP"></span>, CP: <span id="playerCombatCP"></span> / <span id="playerCombatMaxCP"></span></p>
                <p>–ü—Ä–æ—Ç–∏–≤–Ω–∏–∫: <span id="enemyName"></span> (HP: <span id="enemyHP"></span> / <span id="enemyMaxHP"></span>)</p>
                <div id="combatActions" class="combat-actions grid grid-cols-2 gap-2 mt-4">
                    <button id="attackBtn">–ê—Ç–∞–∫–∞ (–¢–∞–π–¥–∑—é—Ü—É)</button>
                    <button id="jutsuBtn">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –î–∑—é—Ü—É</button>
                    <button id="defendBtn">–ó–∞—â–∏—Ç–∞</button>
                    <button id="itemBtn">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ü—Ä–µ–¥–º–µ—Ç</button>
                </div>
                <div id="jutsuSelection" class="hidden mt-4">
                    <h4 class="text-lg mb-2 text-blue-200">–í—ã–±–µ—Ä–∏ –î–∑—é—Ü—É:</h4>
                    <div id="availableJutsuButtons" class="grid grid-cols-2 gap-2"></div>
                    <button id="cancelJutsuBtn" class="mt-2">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>

            <!-- Inventory Display -->
            <div id="inventoryDisplay" class="hidden">
                <h3 class="text-xl mb-2 text-blue-300">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
                <ul id="inventoryList" class="mb-4"></ul>
                <button id="useItemBtn" class="mb-2">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ü—Ä–µ–¥–º–µ—Ç</button>
                <button id="equipItemBtn" class="mb-2">–≠–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å –ü—Ä–µ–¥–º–µ—Ç</button>
                <div id="inventoryMessageBox" class="message-box hidden"></div>
            </div>

            <!-- Training Display -->
            <div id="trainingDisplay" class="hidden">
                <h3 class="text-xl mb-2 text-blue-300">–û–±—É—á–µ–Ω–∏–µ</h3>
                <p>–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –∏–∑—É—á–∞—Ç—å –Ω–æ–≤—ã–µ –¥–∑—é—Ü—É –∏–ª–∏ —É–ª—É—á—à–∞—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏.</p>
                <button id="learnJutsuBtn" class="mb-2">–ò–∑—É—á–∏—Ç—å –î–∑—é—Ü—É</button>
                <button id="improveStatsBtn" class="mb-2">–£–ª—É—á—à–∏—Ç—å –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</button>
                <div id="trainingMessageBox" class="message-box hidden"></div>
            </div>
        </div>
    </div>

    <script>
        // ==================== Telegram Mini Apps Integration ====================
        const tg = window.Telegram.WebApp;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        tg.expand();
        tg.enableClosingConfirmation();
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
        function applyTelegramTheme() {
            document.documentElement.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color || '#1a202c');
            document.documentElement.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color || '#e2e8f0');
            document.documentElement.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color || '#a0aec0');
            document.documentElement.style.setProperty('--tg-theme-link-color', tg.themeParams.link_color || '#4299e1');
            document.documentElement.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color || '#4299e1');
            document.documentElement.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color || '#ffffff');
            document.documentElement.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color || '#2d3748');
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π Telegram
        tg.BackButton.onClick(() => {
            goBack();
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –Ω–∞–∑–∞–¥
        function goBack() {
            if (isCombatActive) {
                endCombat("–í—ã —Å–±–µ–∂–∞–ª–∏ –∏–∑ –±–æ—è!");
                return;
            }
            
            hideAllDisplays();
            gameOutput.classList.remove('hidden');
            updateBackButton();
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥"
        function updateBackButton() {
            if (gameOutput.classList.contains('hidden') || isCombatActive) {
                tg.BackButton.show();
            } else {
                tg.BackButton.hide();
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥" –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
        document.getElementById('tgBackButton').addEventListener('click', goBack);
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä—ã
        function saveGameData() {
            if (player) {
                const gameData = {
                    player: player,
                    currentMission: currentMission,
                    currentEnemy: currentEnemy,
                    isCombatActive: isCombatActive
                };
                
                localStorage.setItem('narutoGameData', JSON.stringify(gameData));
                tg.HapticFeedback.notificationOccurred('success');
                showTelegramNotification("–ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞!");
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–≥—Ä—ã
        function loadGameData() {
            const savedData = localStorage.getItem('narutoGameData');
            if (savedData) {
                try {
                    const gameData = JSON.parse(savedData);
                    player = gameData.player;
                    currentMission = gameData.currentMission;
                    currentEnemy = gameData.currentEnemy;
                    isCombatActive = gameData.isCombatActive;
                    
                    charCreationSection.classList.add('hidden');
                    gameInterfaceSection.classList.remove('hidden');
                    gameOutput.textContent = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ, ${player.name}!`;
                    
                    if (isCombatActive) {
                        startCombat();
                    } else {
                        updateProfileDisplay();
                    }
                    
                    return true;
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", e);
                }
            }
            return false;
        }
        
        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram
        function showTelegramNotification(message) {
            if (tg.showAlert) {
                tg.showAlert(message);
            } else {
                alert(message);
            }
        }
        
        // ==================== Game Logic ====================
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
        let player = null;
        let totalPoints = 10;
        let pointsSpent = 0;
        let currentEnemy = null;
        let isCombatActive = false;
        let currentMission = null;
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const charCreationSection = document.getElementById('characterCreation');
        const gameInterfaceSection = document.getElementById('gameInterface');
        const characterForm = document.getElementById('characterForm');
        const charNameInput = document.getElementById('charName');
        const charVillageSelect = document.getElementById('charVillage');
        const charChakraElementSelect = document.getElementById('charChakraElement');
        const charAppearanceInput = document.getElementById('charAppearance');
        const remainingPointsSpan = document.getElementById('remainingPoints');
        const createCharBtn = document.getElementById('createCharBtn');
        const messageBox = document.getElementById('messageBox');
        const tgSaveButton = document.getElementById('tgSaveButton');
        
        // –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è –≤–≤–æ–¥–∞
        const statInputs = {
            Strength: document.getElementById('statStrength'),
            Agility: document.getElementById('statAgility'),
            Stamina: document.getElementById('statStamina'),
            Chakra: document.getElementById('statChakra'),
            Intellect: document.getElementById('statIntellect')
        };
        
        // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
        document.querySelectorAll('.add-stat-btn').forEach(button => {
            button.addEventListener('click', (e) => adjustStat(e.target.dataset.stat, 1));
        });
        document.querySelectorAll('.remove-stat-btn').forEach(button => {
            button.addEventListener('click', (e) => adjustStat(e.target.dataset.stat, -1));
        });
        
        // –ö–Ω–æ–ø–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        const showProfileBtn = document.getElementById('showProfileBtn');
        const showMissionsBtn = document.getElementById('showMissionsBtn');
        const showInventoryBtn = document.getElementById('showInventoryBtn');
        const showTrainingBtn = document.getElementById('showTrainingBtn');
        
        // –û–±–ª–∞—Å—Ç–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const gameOutput = document.getElementById('gameOutput');
        const profileDisplay = document.getElementById('profileDisplay');
        const missionsDisplay = document.getElementById('missionsDisplay');
        const combatDisplay = document.getElementById('combatDisplay');
        const inventoryDisplay = document.getElementById('inventoryDisplay');
        const trainingDisplay = document.getElementById('trainingDisplay');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –ø—Ä–æ—Ñ–∏–ª—è
        const profileName = document.getElementById('profileName');
        const profileVillage = document.getElementById('profileVillage');
        const profileElement = document.getElementById('profileElement');
        const profileLevel = document.getElementById('profileLevel');
        const profileExp = document.getElementById('profileExp');
        const profileExpToNextLevel = document.getElementById('profileExpToNextLevel');
        const profileHP = document.getElementById('profileHP');
        const profileMaxHP = document.getElementById('profileMaxHP');
        const profileCP = document.getElementById('profileCP');
        const profileMaxCP = document.getElementById('profileMaxCP');
        const profileStrength = document.getElementById('profileStrength');
        const profileAgility = document.getElementById('profileAgility');
        const profileStamina = document.getElementById('profileStamina');
        const profileChakra = document.getElementById('profileChakra');
        const profileIntellect = document.getElementById('profileIntellect');
        const profileAppearance = document.getElementById('profileAppearance');
        const profileJutsuList = document.getElementById('profileJutsuList');
        const profileEquipmentList = document.getElementById('profileEquipmentList');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –º–∏—Å—Å–∏–π
        const missionList = document.getElementById('missionList');
        const takeMissionBtn = document.getElementById('takeMissionBtn');
        const completeMissionBtn = document.getElementById('completeMissionBtn');
        const missionMessageBox = document.getElementById('missionMessageBox');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –±–æ—è
        const combatLog = document.getElementById('combatLog');
        const playerCombatHP = document.getElementById('playerCombatHP');
        const playerCombatMaxHP = document.getElementById('playerCombatMaxHP');
        const playerCombatCP = document.getElementById('playerCombatCP');
        const playerCombatMaxCP = document.getElementById('playerCombatMaxCP');
        const enemyName = document.getElementById('enemyName');
        const enemyHP = document.getElementById('enemyHP');
        const enemyMaxHP = document.getElementById('enemyMaxHP');
        const combatActions = document.getElementById('combatActions');
        const attackBtn = document.getElementById('attackBtn');
        const jutsuBtn = document.getElementById('jutsuBtn');
        const defendBtn = document.getElementById('defendBtn');
        const itemBtn = document.getElementById('itemBtn');
        const jutsuSelection = document.getElementById('jutsuSelection');
        const availableJutsuButtons = document.getElementById('availableJutsuButtons');
        const cancelJutsuBtn = document.getElementById('cancelJutsuBtn');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        const inventoryList = document.getElementById('inventoryList');
        const useItemBtn = document.getElementById('useItemBtn');
        const equipItemBtn = document.getElementById('equipItemBtn');
        const inventoryMessageBox = document.getElementById('inventoryMessageBox');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –æ–±—É—á–µ–Ω–∏—è
        const learnJutsuBtn = document.getElementById('learnJutsuBtn');
        const improveStatsBtn = document.getElementById('improveStatsBtn');
        const trainingMessageBox = document.getElementById('trainingMessageBox');
        
        // --- –ò–≥—Ä–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–¥–ª—è —Å–∏–º—É–ª—è—Ü–∏–∏) ---
        const missions = [
            { id: 'm1', name: '–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤—Ü–∞', rank: 'D', description: '–¢–µ–±–µ –ø–æ—Ä—É—á–µ–Ω–æ —Å–æ–ø—Ä–æ–≤–æ–¥–∏—Ç—å —Ç–æ—Ä–≥–æ–≤—Ü–∞ –∏–∑ –ö–æ–Ω–æ—Ö–∏ –≤ —Å–æ—Å–µ–¥–Ω—é—é –¥–µ—Ä–µ–≤–Ω—é, –∑–∞—â–∏—â–∞—è –µ–≥–æ –æ—Ç –º–µ–ª–∫–∏—Ö –±–∞–Ω–¥–∏—Ç–æ–≤.', rewardExp: 500, rewardRyo: 200, enemy: { name: '–ë–∞–Ω–¥–∏—Ç', hp: 80, strength: 10, agility: 5, expReward: 100 } },
            { id: 'm2', name: '–û—Ö–æ—Ç–∞ –Ω–∞ –¥–∏–∫–∏—Ö –∑–≤–µ—Ä–µ–π', rank: 'D', description: '–û—á–∏—Å—Ç–∏—Ç—å –ª–µ—Å –æ—Ç –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã—Ö –¥–∏–∫–∏—Ö –∑–≤–µ—Ä–µ–π.', rewardExp: 600, rewardRyo: 250, enemy: { name: '–î–∏–∫–∏–π –í–æ–ª–∫', hp: 90, strength: 12, agility: 8, expReward: 120 } },
            { id: 'm3', name: '–ü–æ–∏—Å–∫ –ø—Ä–æ–ø–∞–≤—à–µ–≥–æ —Å–≤–∏—Ç–∫–∞', rank: 'C', description: '–ù–∞–π—Ç–∏ —Å–≤–∏—Ç–æ–∫, —É–∫—Ä–∞–¥–µ–Ω–Ω—ã–π –Ω–∏–Ω–¥–∑—è-–æ—Ç—Å—Ç—É–ø–Ω–∏–∫–æ–º.', rewardExp: 1200, rewardRyo: 500, enemy: { name: '–ù–∏–Ω–¥–∑—è-–æ—Ç—Å—Ç—É–ø–Ω–∏–∫', hp: 150, strength: 18, agility: 12, expReward: 250 } }
        ];
        
        const jutsuData = {
            '–û–≥–æ–Ω—å': [{ name: '–û–≥–Ω–µ–Ω–Ω—ã–π –®–∞—Ä', cost: 15, damageMultiplier: 1.5 }],
            '–í–æ–¥–∞': [{ name: '–í–æ–¥—è–Ω–æ–π –î—Ä–∞–∫–æ–Ω', cost: 20, damageMultiplier: 1.7 }],
            '–í–µ—Ç–µ—Ä': [{ name: '–í–µ—Ç—Ä—è–Ω–æ–π –ü–æ—Ä–µ–∑', cost: 12, damageMultiplier: 1.3 }],
            '–ú–æ–ª–Ω–∏—è': [{ name: '–ß–∏–¥–æ—Ä–∏ (–±–∞–∑–æ–≤–æ–µ)', cost: 25, damageMultiplier: 2.0 }],
            '–ó–µ–º–ª—è': [{ name: '–ö–∞–º–µ–Ω–Ω–∞—è –°—Ç–µ–Ω–∞', cost: 10, defenseBonus: 0.5 }],
            '–¢–∞–π–¥–∑—é—Ü—É': [{ name: '–õ–∏—Å—Ç–∫–æ–≤–∞—è –õ–æ–≤–∫–æ—Å—Ç—å', cost: 0, damageMultiplier: 1.0 }],
            '–ì–µ–Ω–¥–∑—é—Ü—É': [{ name: '–ò–ª–ª—é–∑–∏—è: –ó–∞–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–æ', cost: 10, effect: 'stun', duration: 1 }]
        };
        
        const itemsData = [
            { id: 'hp_potion', name: '–ú–∞–ª–æ–µ –∑–µ–ª—å–µ –∑–¥–æ—Ä–æ–≤—å—è', type: 'consumable', effect: { type: 'heal', value: 30 } },
            { id: 'cp_potion', name: '–ú–∞–ª–æ–µ –∑–µ–ª—å–µ —á–∞–∫—Ä—ã', type: 'consumable', effect: { type: 'restore_cp', value: 20 } },
            { id: 'kunai', name: '–ö—É–Ω–∞–π', type: 'weapon', attackBonus: 5 },
            { id: 'shinobi_vest', name: '–ñ–∏–ª–µ—Ç —à–∏–Ω–æ–±–∏', type: 'armor', defenseBonus: 3 }
        ];
        
        // --- –§—É–Ω–∫—Ü–∏–∏ –∏–≥—Ä—ã ---
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –æ—á–∫–æ–≤
        function updateRemainingPoints() {
            pointsSpent = parseInt(statInputs.Strength.value) +
                          parseInt(statInputs.Agility.value) +
                          parseInt(statInputs.Stamina.value) +
                          parseInt(statInputs.Chakra.value) +
                          parseInt(statInputs.Intellect.value);
            remainingPointsSpan.textContent = `–û—Å—Ç–∞–ª–æ—Å—å –æ—á–∫–æ–≤: ${totalPoints - pointsSpent}`;
            createCharBtn.disabled = (totalPoints - pointsSpent !== 0);
        }
        
        // –†–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        function adjustStat(statName, change) {
            let currentValue = parseInt(statInputs[statName].value);
            let newTotal = pointsSpent + change;
            
            if (change > 0) {
                if (newTotal <= totalPoints) {
                    statInputs[statName].value = currentValue + 1;
                } else {
                    showMessage("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤!", true);
                }
            } else {
                if (currentValue > 0) {
                    statInputs[statName].value = currentValue - 1;
                } else {
                    showMessage("–ù–µ–ª—å–∑—è —É–º–µ–Ω—å—à–∏—Ç—å –Ω–∏–∂–µ –Ω—É–ª—è!", true);
                }
            }
            updateRemainingPoints();
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(msg, isError = false) {
            if (tg.showAlert) {
                tg.showAlert(msg);
            } else {
                messageBox.textContent = msg;
                messageBox.classList.remove('hidden');
                if (isError) {
                    messageBox.style.backgroundColor = '#c53030';
                } else {
                    messageBox.style.backgroundColor = '#2c5282';
                }
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 3000);
            }
        }
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        characterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            if (totalPoints - pointsSpent !== 0) {
                showMessage("–†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –≤—Å–µ 10 –æ—á–∫–æ–≤ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫!", true);
                return;
            }
            
            player = {
                name: charNameInput.value,
                village: charVillageSelect.value,
                chakraElement: charChakraElementSelect.value,
                appearance: charAppearanceInput.value || '–û–±—ã—á–Ω–∞—è –≤–Ω–µ—à–Ω–æ—Å—Ç—å —à–∏–Ω–æ–±–∏.',
                level: 1,
                exp: 0,
                expToNextLevel: 1000,
                stats: {
                    strength: parseInt(statInputs.Strength.value),
                    agility: parseInt(statInputs.Agility.value),
                    stamina: parseInt(statInputs.Stamina.value),
                    chakra: parseInt(statInputs.Chakra.value),
                    intellect: parseInt(statInputs.Intellect.value)
                },
                hp: 0,
                maxHp: 0,
                cp: 0,
                maxCp: 0,
                jutsu: [],
                inventory: [],
                equipment: {
                    weapon: null,
                    armor: null,
                    accessory: null
                },
                ryo: 500
            };
            
            // –†–∞—Å—á–µ—Ç —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
            player.maxHp = 100 + (player.stats.stamina * 10);
            player.hp = player.maxHp;
            player.maxCp = 50 + (player.stats.chakra * 5);
            player.cp = player.maxCp;
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –¥–∑—é—Ü—É
            player.jutsu.push(jutsuData.–¢–∞–π–¥–∑—é—Ü—É[0]);
            if (jutsuData[player.chakraElement] && jutsuData[player.chakraElement][0]) {
                player.jutsu.push(jutsuData[player.chakraElement][0]);
            }
            
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—Ç–æ–≤—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤
            player.inventory.push(itemsData.find(item => item.id === 'hp_potion'));
            player.inventory.push(itemsData.find(item => item.id === 'kunai'));
            player.inventory.push(itemsData.find(item => item.id === 'shinobi_vest'));
            
            // –≠–∫–∏–ø–∏—Ä–æ–≤–∫–∞ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è
            player.equipment.weapon = itemsData.find(item => item.id === 'kunai');
            player.equipment.armor = itemsData.find(item => item.id === 'shinobi_vest');
            
            charCreationSection.classList.add('hidden');
            gameInterfaceSection.classList.remove('hidden');
            gameOutput.textContent = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${player.name} –∏–∑ ${player.village}! –¢–≤–æ–π –ø—É—Ç—å —à–∏–Ω–æ–±–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è!`;
            
            saveGameData();
            updateProfileDisplay();
            updateBackButton();
        });
        
        // --- –§—É–Ω–∫—Ü–∏–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–≥—Ä–æ–≤–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ ---
        
        // –°–∫—Ä—ã—Ç—å –≤—Å–µ –∏–≥—Ä–æ–≤—ã–µ –¥–∏—Å–ø–ª–µ–∏
        function hideAllDisplays() {
            profileDisplay.classList.add('hidden');
            missionsDisplay.classList.add('hidden');
            combatDisplay.classList.add('hidden');
            inventoryDisplay.classList.add('hidden');
            trainingDisplay.classList.add('hidden');
            gameOutput.classList.remove('hidden');
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        showProfileBtn.addEventListener('click', () => {
            hideAllDisplays();
            profileDisplay.classList.remove('hidden');
            updateProfileDisplay();
            gameOutput.classList.add('hidden');
            updateBackButton();
        });
        
        function updateProfileDisplay() {
            if (!player) return;
            
            profileName.textContent = player.name;
            profileVillage.textContent = player.village;
            profileElement.textContent = player.chakraElement;
            profileLevel.textContent = player.level;
            profileExp.textContent = player.exp;
            profileExpToNextLevel.textContent = player.expToNextLevel;
            profileHP.textContent = player.hp;
            profileMaxHP.textContent = player.maxHp;
            profileCP.textContent = player.cp;
            profileMaxCP.textContent = player.maxCp;
            profileStrength.textContent = player.stats.strength;
            profileAgility.textContent = player.stats.agility;
            profileStamina.textContent = player.stats.stamina;
            profileChakra.textContent = player.stats.chakra;
            profileIntellect.textContent = player.stats.intellect;
            profileAppearance.textContent = player.appearance;
            
            profileJutsuList.innerHTML = '';
            if (player.jutsu.length === 0) {
                profileJutsuList.innerHTML = '<li>–ù–µ—Ç –∏–∑—É—á–µ–Ω–Ω—ã—Ö –¥–∑—é—Ü—É.</li>';
            } else {
                player.jutsu.forEach(j => {
                    const li = document.createElement('li');
                    li.textContent = `${j.name} (–°—Ç–æ–∏–º–æ—Å—Ç—å: ${j.cost || 0} CP)`;
                    profileJutsuList.appendChild(li);
                });
            }
            
            profileEquipmentList.innerHTML = '';
            if (!player.equipment.weapon && !player.equipment.armor && !player.equipment.accessory) {
                profileEquipmentList.innerHTML = '<li>–ù–∏—á–µ–≥–æ –Ω–µ —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ.</li>';
            } else {
                if (player.equipment.weapon) {
                    const li = document.createElement('li');
                    li.textContent = `–û—Ä—É–∂–∏–µ: ${player.equipment.weapon.name} (–ê—Ç–∞–∫–∞: +${player.equipment.weapon.attackBonus || 0})`;
                    profileEquipmentList.appendChild(li);
                }
                if (player.equipment.armor) {
                    const li = document.createElement('li');
                    li.textContent = `–ë—Ä–æ–Ω—è: ${player.equipment.armor.name} (–ó–∞—â–∏—Ç–∞: +${player.equipment.armor.defenseBonus || 0})`;
                    profileEquipmentList.appendChild(li);
                }
                if (player.equipment.accessory) {
                    const li = document.createElement('li');
                    li.textContent = `–ê–∫—Å–µ—Å—Å—É–∞—Ä: ${player.equipment.accessory.name}`;
                    profileEquipmentList.appendChild(li);
                }
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –º–∏—Å—Å–∏–∏
        showMissionsBtn.addEventListener('click', () => {
            hideAllDisplays();
            missionsDisplay.classList.remove('hidden');
            gameOutput.classList.add('hidden');
            loadMissions();
            updateBackButton();
        });
        
        function loadMissions() {
            missionList.innerHTML = '';
            missions.forEach(mission => {
                const li = document.createElement('li');
                li.innerHTML = `<input type="radio" name="selectedMission" value="${mission.id}" id="mission-${mission.id}">
                                <label for="mission-${mission.id}"><strong>[–†–∞–Ω–≥ ${mission.rank}] ${mission.name}</strong>: ${mission.description}</label>`;
                missionList.appendChild(li);
            });
            takeMissionBtn.classList.remove('hidden');
            completeMissionBtn.classList.add('hidden');
            missionMessageBox.classList.add('hidden');
        }
        
        // –í–∑—è—Ç—å –º–∏—Å—Å–∏—é
        takeMissionBtn.addEventListener('click', () => {
            const selectedMissionId = document.querySelector('input[name="selectedMission"]:checked')?.value;
            if (selectedMissionId) {
                currentMission = missions.find(m => m.id === selectedMissionId);
                gameOutput.textContent = `–¢—ã –≤–∑—è–ª –º–∏—Å—Å–∏—é: "${currentMission.name}". ${currentMission.description}`;
                hideAllDisplays();
                gameOutput.classList.remove('hidden');
                startMissionEncounter();
            } else {
                missionMessageBox.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–∏—Å—Å–∏—é.';
                missionMessageBox.classList.remove('hidden');
            }
        });
        
        // –ù–∞—á–∞–ª–æ —Å–∏–º—É–ª—è—Ü–∏–∏ –º–∏—Å—Å–∏–∏
        function startMissionEncounter() {
            if (currentMission && currentMission.enemy) {
                currentEnemy = { ...currentMission.enemy };
                currentEnemy.currentHp = currentEnemy.hp;
                startCombat();
            } else {
                gameOutput.textContent += '\n–ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! –í–æ–∑–≤—Ä–∞—â–∞–π—Å—è –≤ –¥–µ—Ä–µ–≤–Ω—é, —á—Ç–æ–±—ã —Å–¥–∞—Ç—å –µ—ë.';
                completeMissionBtn.classList.remove('hidden');
                takeMissionBtn.classList.add('hidden');
            }
        }
        
        // –°–¥–∞—Ç—å –º–∏—Å—Å–∏—é
        completeMissionBtn.addEventListener('click', () => {
            if (currentMission) {
                player.exp += currentMission.rewardExp;
                player.ryo += currentMission.rewardRyo;
                gameOutput.textContent = `–ú–∏—Å—Å–∏—è "${currentMission.name}" —Å–¥–∞–Ω–∞! –¢—ã –ø–æ–ª—É—á–∏–ª ${currentMission.rewardExp} –æ–ø—ã—Ç–∞ –∏ ${currentMission.rewardRyo} —Ä—ë.`;
                checkLevelUp();
                currentMission = null;
                completeMissionBtn.classList.add('hidden');
                takeMissionBtn.classList.remove('hidden');
                updateProfileDisplay();
                saveGameData();
            }
        });
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è
        function checkLevelUp() {
            while (player.exp >= player.expToNextLevel) {
                player.level++;
                player.exp -= player.expToNextLevel;
                player.expToNextLevel = Math.floor(player.expToNextLevel * 1.5);
                player.maxHp += 10;
                player.hp = player.maxHp;
                player.maxCp += 5;
                player.cp = player.maxCp;
                gameOutput.textContent += `\n–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –¢—ã –¥–æ—Å—Ç–∏–≥ ${player.level} —É—Ä–æ–≤–Ω—è! –¢–≤–æ–∏ HP –∏ CP –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.`;
                saveGameData();
            }
        }
        
        // --- –ë–æ–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ ---
        
        function startCombat() {
            isCombatActive = true;
            hideAllDisplays();
            combatDisplay.classList.remove('hidden');
            combatLog.textContent = `–¢—ã —Å—Ç–æ–ª–∫–Ω—É–ª—Å—è —Å ${currentEnemy.name}!\n`;
            tg.BackButton.setText("–°–±–µ–∂–∞—Ç—å");
            updateBackButton();
            updateCombatDisplay();
        }
        
        function updateCombatDisplay() {
            playerCombatHP.textContent = player.hp;
            playerCombatMaxHP.textContent = player.maxHp;
            playerCombatCP.textContent = player.cp;
            playerCombatMaxCP.textContent = player.maxCp;
            enemyName.textContent = currentEnemy.name;
            enemyHP.textContent = currentEnemy.currentHp;
            enemyMaxHP.textContent = currentEnemy.hp;
            
            combatActions.classList.remove('hidden');
            jutsuSelection.classList.add('hidden');
        }
        
        function endCombat(outcome) {
            isCombatActive = false;
            currentEnemy = null;
            combatLog.textContent += `\n–ë–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω. ${outcome}\n`;
            gameOutput.textContent = combatLog.textContent;
            hideAllDisplays();
            gameOutput.classList.remove('hidden');
            tg.BackButton.setText("–ù–∞–∑–∞–¥");
            updateBackButton();
            
            if (outcome.includes("–ø–æ–±–µ–¥–∏–ª")) {
                gameOutput.textContent += '\n–ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! –í–æ–∑–≤—Ä–∞—â–∞–π—Å—è –≤ –¥–µ—Ä–µ–≤–Ω—é, —á—Ç–æ–±—ã —Å–¥–∞—Ç—å –µ—ë.';
                completeMissionBtn.classList.remove('hidden');
                takeMissionBtn.classList.add('hidden');
            } else {
                gameOutput.textContent += '\n–¢—ã –ø–æ—Ç–µ—Ä–ø–µ–ª –ø–æ—Ä–∞–∂–µ–Ω–∏–µ –∏ –≤–µ—Ä–Ω—É–ª—Å—è –≤ –¥–µ—Ä–µ–≤–Ω—é. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑!';
                player.hp = player.maxHp;
                player.cp = player.maxCp;
                updateProfileDisplay();
                completeMissionBtn.classList.add('hidden');
                takeMissionBtn.classList.remove('hidden');
            }
            saveGameData();
        }
        
        // –•–æ–¥ –∏–≥—Ä–æ–∫–∞
        attackBtn.addEventListener('click', () => playerTurn('attack'));
        defendBtn.addEventListener('click', () => playerTurn('defend'));
        itemBtn.addEventListener('click', () => playerTurn('item'));
        
        jutsuBtn.addEventListener('click', () => {
            combatActions.classList.add('hidden');
            jutsuSelection.classList.remove('hidden');
            availableJutsuButtons.innerHTML = '';
            player.jutsu.forEach(j => {
                const btn = document.createElement('button');
                btn.textContent = `${j.name} (${j.cost || 0} CP)`;
                btn.classList.add('jutsu-select-btn');
                btn.disabled = player.cp < (j.cost || 0);
                btn.addEventListener('click', () => playerTurn('jutsu', j));
                availableJutsuButtons.appendChild(btn);
            });
        });
        
        cancelJutsuBtn.addEventListener('click', () => {
            jutsuSelection.classList.add('hidden');
            combatActions.classList.remove('hidden');
        });
        
        async function playerTurn(action, jutsu = null) {
            if (!isCombatActive) return;
            
            let playerDamage = 0;
            let logMessage = '';
            
            switch (action) {
                case 'attack':
                    playerDamage = player.stats.strength * (1 + (player.equipment.weapon?.attackBonus || 0) / 10);
                    playerDamage = Math.max(1, Math.floor(playerDamage * (1 + Math.random() * 0.2 - 0.1)));
                    currentEnemy.currentHp -= playerDamage;
                    logMessage = `–¢—ã –∞—Ç–∞–∫—É–µ—à—å ${currentEnemy.name} –∏ –Ω–∞–Ω–æ—Å–∏—à—å ${playerDamage.toFixed(0)} —É—Ä–æ–Ω–∞!`;
                    break;
                case 'jutsu':
                    if (!jutsu) {
                        logMessage = '–û—à–∏–±–∫–∞: –î–∑—é—Ü—É –Ω–µ –≤—ã–±—Ä–∞–Ω–æ.';
                        break;
                    }
                    if (player.cp < jutsu.cost) {
                        logMessage = '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —á–∞–∫—Ä—ã –¥–ª—è —ç—Ç–æ–≥–æ –¥–∑—é—Ü—É!';
                        break;
                    }
                    player.cp -= jutsu.cost;
                    if (jutsu.damageMultiplier) {
                        playerDamage = (player.stats.intellect * jutsu.damageMultiplier) * (1 + Math.random() * 0.2 - 0.1);
                        playerDamage = Math.max(1, Math.floor(playerDamage));
                        currentEnemy.currentHp -= playerDamage;
                        logMessage = `–¢—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å ${jutsu.name} –∏ –Ω–∞–Ω–æ—Å–∏—à—å ${playerDamage.toFixed(0)} —É—Ä–æ–Ω–∞!`;
                    } else if (jutsu.effect === 'stun') {
                        logMessage = `–¢—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å ${jutsu.name} –∏ –æ–≥–ª—É—à–∞–µ—à—å ${currentEnemy.name} –Ω–∞ ${jutsu.duration} —Ö–æ–¥!`;
                    } else if (jutsu.defenseBonus) {
                        logMessage = `–¢—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å ${jutsu.name} –∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—à—å —Å–≤–æ—é –∑–∞—â–∏—Ç—É!`;
                    }
                    break;
                case 'defend':
                    logMessage = '–¢—ã –ø—Ä–∏–Ω–∏–º–∞–µ—à—å –∑–∞—â–∏—Ç–Ω—É—é —Å—Ç–æ–π–∫—É.';
                    break;
                case 'item':
                    logMessage = '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ –±–æ—é.';
                    break;
            }
            
            combatLog.textContent += `\n${logMessage}`;
            updateCombatDisplay();
            
            if (currentEnemy.currentHp <= 0) {
                endCombat(`–¢—ã –ø–æ–±–µ–¥–∏–ª ${currentEnemy.name}! –¢—ã –ø–æ–ª—É—á–∏–ª ${currentEnemy.expReward} –æ–ø—ã—Ç–∞.`);
                player.exp += currentEnemy.expReward;
                checkLevelUp();
                updateProfileDisplay();
                return;
            }
            
            // –•–æ–¥ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞
            await new Promise(resolve => setTimeout(resolve, 1000));
            enemyTurn();
        }
        
        function enemyTurn() {
            if (!isCombatActive) return;
            
            let enemyDamage = currentEnemy.strength * (1 + Math.random() * 0.2 - 0.1);
            enemyDamage = Math.max(1, Math.floor(enemyDamage));
            player.hp -= enemyDamage;
            combatLog.textContent += `\n${currentEnemy.name} –∞—Ç–∞–∫—É–µ—Ç —Ç–µ–±—è –∏ –Ω–∞–Ω–æ—Å–∏—Ç ${enemyDamage.toFixed(0)} —É—Ä–æ–Ω–∞!`;
            updateCombatDisplay();
            
            if (player.hp <= 0) {
                endCombat('–¢—ã –ø–æ—Ç–µ—Ä–ø–µ–ª –ø–æ—Ä–∞–∂–µ–Ω–∏–µ...');
                return;
            }
        }
        
        // --- –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å ---
        showInventoryBtn.addEventListener('click', () => {
            hideAllDisplays();
            inventoryDisplay.classList.remove('hidden');
            gameOutput.classList.add('hidden');
            updateInventoryDisplay();
            updateBackButton();
        });
        
        function updateInventoryDisplay() {
            inventoryList.innerHTML = '';
            if (player.inventory.length === 0) {
                inventoryList.innerHTML = '<li>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç.</li>';
            } else {
                player.inventory.forEach((item, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<input type="radio" name="selectedItem" value="${index}" id="item-${index}">
                                    <label for="item-${index}">${item.name} (${item.type})</label>`;
                    inventoryList.appendChild(li);
                });
            }
            inventoryMessageBox.classList.add('hidden');
        }
        
        useItemBtn.addEventListener('click', () => {
            const selectedItemIndex = document.querySelector('input[name="selectedItem"]:checked')?.value;
            if (selectedItemIndex !== undefined) {
                const item = player.inventory[selectedItemIndex];
                if (item.type === 'consumable') {
                    if (item.effect.type === 'heal') {
                        player.hp = Math.min(player.maxHp, player.hp + item.effect.value);
                        inventoryMessageBox.textContent = `–¢—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª ${item.name} –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª ${item.effect.value} HP!`;
                    } else if (item.effect.type === 'restore_cp') {
                        player.cp = Math.min(player.maxCp, player.cp + item.effect.value);
                        inventoryMessageBox.textContent = `–¢—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª ${item.name} –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª ${item.effect.value} CP!`;
                    }
                    player.inventory.splice(selectedItemIndex, 1);
                    inventoryMessageBox.classList.remove('hidden');
                    updateInventoryDisplay();
                    updateProfileDisplay();
                    saveGameData();
                } else {
                    inventoryMessageBox.textContent = '–≠—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º.';
                    inventoryMessageBox.classList.remove('hidden');
                }
            } else {
                inventoryMessageBox.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è.';
                inventoryMessageBox.classList.remove('hidden');
            }
        });
        
        equipItemBtn.addEventListener('click', () => {
            const selectedItemIndex = document.querySelector('input[name="selectedItem"]:checked')?.value;
            if (selectedItemIndex !== undefined) {
                const item = player.inventory[selectedItemIndex];
                if (item.type === 'weapon' || item.type === 'armor' || item.type === 'accessory') {
                    if (player.equipment[item.type]) {
                        player.inventory.push(player.equipment[item.type]);
                    }
                    player.equipment[item.type] = item;
                    player.inventory.splice(selectedItemIndex, 1);
                    inventoryMessageBox.textContent = `–¢—ã —ç–∫–∏–ø–∏—Ä–æ–≤–∞–ª ${item.name}!`;
                    inventoryMessageBox.classList.remove('hidden');
                    updateInventoryDisplay();
                    updateProfileDisplay();
                    saveGameData();
                } else {
                    inventoryMessageBox.textContent = '–≠—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç –Ω–µ–ª—å–∑—è —ç–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å.';
                    inventoryMessageBox.classList.remove('hidden');
                }
            } else {
                inventoryMessageBox.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏.';
                inventoryMessageBox.classList.remove('hidden');
            }
        });
        
        // --- –û–±—É—á–µ–Ω–∏–µ ---
        showTrainingBtn.addEventListener('click', () => {
            hideAllDisplays();
            trainingDisplay.classList.remove('hidden');
            gameOutput.classList.add('hidden');
            updateBackButton();
        });
        
        learnJutsuBtn.addEventListener('click', () => {
            trainingMessageBox.textContent = '–ò–∑—É—á–µ–Ω–∏–µ –¥–∑—é—Ü—É –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ. –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∑—é—Ü—É –∏ —É—Å–ª–æ–≤–∏—è –∏—Ö –∏–∑—É—á–µ–Ω–∏—è.';
            trainingMessageBox.classList.remove('hidden');
        });
        
        improveStatsBtn.addEventListener('click', () => {
            trainingMessageBox.textContent = '–£–ª—É—á—à–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ. –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –±—É–¥–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å –æ—á–∫–∏, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∑–∞ —É—Ä–æ–≤–µ–Ω—å.';
            trainingMessageBox.classList.remove('hidden');
        });
        
        // ==================== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ ====================
        document.addEventListener('DOMContentLoaded', () => {
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç–µ–º—É Telegram
            applyTelegramTheme();
            
            // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –∏–≥—Ä—É
            if (!loadGameData()) {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–π –∏–≥—Ä—ã
                updateRemainingPoints();
            }
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"
            updateBackButton();
            
            // –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            tgSaveButton.addEventListener('click', saveGameData);
            
            // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
            window.addEventListener('beforeunload', () => {
                saveGameData();
            });
        });
    </script>
</body>
</html>